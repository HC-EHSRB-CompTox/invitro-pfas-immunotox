#Load libraries
```{r}
library(readxl)
library(tidyr)  
library(dplyr)  
library(ggsignif)
library(ggplot2)
library(broom) 
library(rstatix)
library(ggpubr)
library(stringr)
library(viridis)
library(emmeans)
library(purrr)
library(car)
library(extrafont)
library(plotrix)

output_dir <- "C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/invitro pfas/Jurkat/plots_output/"
dir.create(output_dir, showWarnings = FALSE)
```

#Load data
```{r}
data_48 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/invitro pfas/Jurkat/48h analysis.wsp FlowJo table.csv") 
data_72 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/invitro pfas/Jurkat/72h analysis.wsp FlowJo table.csv") 
data_96 <- read.csv("C:/Users/aloan/OneDrive - HC-SC PHAC-ASPC/Desktop/invitro pfas/Jurkat/96h analysis.wsp FlowJo table.csv") 
data_48$time <- 48
data_72$time <- 72
data_96$time <- 96


data <- rbind(data_48, data_72, data_96)
data$X <- gsub("\\s{2,}", " ", data$X)
data <- data %>%
  slice(-c(97,98, 195, 196,293,294))

cleaned_data <- data %>%
  mutate(
    words = str_split(X, " ", simplify = FALSE),
    Row = map_chr(words, ~ .x[1]),

    Replicate = map_chr(words, ~ {
      matches <- str_subset(.x, "^(n=\\d+|[MF]\\d)$")
      if (length(matches) > 0) matches[1] else NA_character_
    }),

    n = map_chr(words, ~ {
      reps <- str_subset(.x, "^rep\\d$")
      if (length(reps) > 0) reps[1] else NA_character_
    }),

    Replicate_Index = map_int(words, ~ {
      idx <- str_which(.x, "^rep\\d$")
      if (length(idx) > 0) idx[1] else NA_integer_
    }),

    Sample = map2_chr(words, Replicate_Index, ~ {
      if (.y > 2) {
        sample_text <- paste(.x[2:(.y - 1)], collapse = " ")
        sample_text <- str_remove(sample_text, "\\s*n=\\d+$")
      } else {
        sample_text <- ""
      }
      sample_text
    }),

    Chemical = str_match(Sample, "^(.*?)\\+PHA")[,2],
    Dose = str_match(Sample, "PHA([0-9.]+)")[,2] %>%
      as.numeric() %>%
      replace_na(0)
  ) %>%
  rename(
    CFSE_fi = cells.Single.Cells.live...Mean..CFSE...Area.,
    dead_fi = cells.Single.Cells.dead...Mean..CFSE...Area.,
    live = cells.Single.Cells.live...Freq..of.Parent....
  ) %>%
  select(
    Row, Replicate, Sample, Chemical, Dose, n,
    CFSE_fi, live, time, dead_fi
  )

numeric_columns <- c("CFSE_fi", "live", "dead_fi")
cleaned_data <- cleaned_data %>%
  mutate(across(all_of(numeric_columns), ~ as.numeric(gsub(",", ".", .))))

cleaned_data <- cleaned_data %>%
  pivot_longer(cols = c("CFSE_fi", "live", "dead_fi"), 
               names_to = "Marker", 
               values_to = "Value")

averaged_data <- cleaned_data %>%
  group_by(Replicate, time, Chemical, Dose, Marker, Sample) %>%
  summarise(Avg_Value = mean(Value, na.rm = TRUE), .groups = "drop")

averaged_data <- averaged_data %>%
  mutate(Dose = as.numeric(Dose))

vehicle_lookup <- averaged_data %>%
  filter(Dose == 0) %>%
  group_by(Replicate, time, Chemical, Marker) %>%   # guard against multiple rows at Dose 0
  summarise(Vehicle_Avg = mean(Avg_Value, na.rm = TRUE), .groups = "drop")

averaged_data <- averaged_data %>%
  left_join(vehicle_lookup, by = c("Replicate", "time", "Chemical", "Marker"))

normalized_data <- averaged_data %>%
  mutate(
    Fold_Change = Avg_Value / Vehicle_Avg
  )


normalized_data$Dose <- as.numeric(normalized_data$Dose)

normalized_data <- normalized_data %>%
  mutate(
    CFSE_fi_Reciprocal = case_when(
      Marker == "CFSE_fi" & Dose != 0 ~ 1 / Fold_Change,
      TRUE ~ NA_real_  
    )
  )
normalized_data <- normalized_data %>%
  mutate(
    dead_fi_Reciprocal = case_when(
      Marker == "dead_fi" & Dose != 0 ~ 1 / Fold_Change,
      TRUE ~ NA_real_  
    )
  )
normalized_data <- normalized_data %>%
  mutate(
    value = case_when(
      Marker == "CFSE_fi" ~ CFSE_fi_Reciprocal,
      Marker == "dead_fi" ~ dead_fi_Reciprocal,
    Marker == "live" ~ Avg_Value
    )
  )

normalized_data <- normalized_data %>%
  mutate(value = replace_na(value, 1))

normalized_data <- normalized_data %>%
  mutate(Sample = str_remove_all(Sample, "PFOS\\+|PFOA\\+"))

filtered_datasets <- normalized_data %>%
  group_split(Marker) %>%
  setNames(unique(averaged_data$Marker))

```

#FI CFSE repciprocal
```{r}
chemical_order <- c("PFOS", "PFOA")
selected_objects <- c("CFSE_fi")
filtered_datasets2 <- filtered_datasets[names(filtered_datasets) %in% selected_objects]

significance_results <- list()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]]

  dataset <- dataset %>% mutate(Dose = as.numeric(Dose))

  unique_times <- sort(unique(dataset$time), na.last = NA)

  for (tt in unique_times) {
    time_data <- dataset %>% filter(time == tt)

    unique_chemicals <- unique(time_data$Chemical)

    for (chem in unique_chemicals) {
      chem_data <- time_data %>% filter(Chemical == chem)

      anova_model <- aov(value ~ Sample + Error(Replicate/Sample), data = chem_data)

      tukey_results <- emmeans(anova_model, pairwise ~ Sample)
      pairwise_results <- as.data.frame(tukey_results$contrasts)

      pairwise_results <- pairwise_results %>%
        mutate(
          significance = case_when(
            p.value < 0.001 ~ "***",
            p.value < 0.01  ~ "**",
            p.value < 0.05  ~ "*",
            p.value >= 0.05 & p.value < 0.099 ~ ".",
            TRUE ~ NA_character_
          )
        ) %>%
        separate(contrast, into = c("group1", "group2"), sep = " - ") %>%
        mutate(
          group1 = str_replace_all(group1, "[()]", ""),
          group2 = str_replace_all(group2, "[()]", "")
        )

      max_y   <- max(chem_data$CFSE_fi_Reciprocal, na.rm = TRUE)
      increment <- max_y * 0.05

      significance_labels <- pairwise_results %>%
        filter(group1 %in% "PHA0uM" | group2 %in% "PHA0uM") %>%
        mutate(y.position = max_y + (row_number() - 1) * increment)

      if (!is.list(significance_results[[dataset_name]])) {
        significance_results[[dataset_name]] <- list()
      }
      if (!is.list(significance_results[[dataset_name]][[as.character(tt)]])) {
        significance_results[[dataset_name]][[as.character(tt)]] <- list()
      }
      significance_results[[dataset_name]][[as.character(tt)]][[chem]] <- significance_labels
    }
  }
}

significance_df <- data.frame()

for (dataset_name in names(significance_results)) {
  for (tt in names(significance_results[[dataset_name]])) {
    for (chem in names(significance_results[[dataset_name]][[tt]])) {
      sig_lab <- significance_results[[dataset_name]][[tt]][[chem]]
      if (is.null(sig_lab) || nrow(sig_lab) == 0) next
      sig_lab$chemical     <- chem
      sig_lab$dataset_name <- dataset_name
      sig_lab$time         <- as.numeric(tt)
      significance_df <- rbind(significance_df, sig_lab)
    }
  }
}
extract_um <- function(x) {
  as.numeric(str_match(x, "PHA\\s*(-?\\d*\\.?\\d+)\\s*uM")[,2])
}

significance_df <- significance_df %>%
  mutate(
    swap_needed = group1 != "PHA0uM" & group2 == "PHA0uM",
    tmp_g1 = if_else(swap_needed, group2, group1),
    tmp_g2 = if_else(swap_needed, group1, group2),
    group1 = tmp_g1,
    group2 = tmp_g2
  ) %>%
  select(-tmp_g1, -tmp_g2, -swap_needed) %>%
  mutate(
    dose_num = extract_um(group2) 
  )

significance_df <- significance_df %>% arrange(time, chemical, dataset_name)

combined_data <- data.frame()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]] %>%
    mutate(Dose = as.numeric(Dose))

  mean_data <- dataset %>%
    group_by(time, Chemical, Dose, Sample) %>%
    summarise(
      mean_stat = mean(value, na.rm = TRUE),
      se_stat   = std.error(value) * 2.365,
      .groups   = "drop"
    ) %>%
    mutate(
      Dataset = dataset_name,
      Marker  = case_when(grepl("CFSE", dataset_name) ~ "CFSE")
    )

  combined_data <- rbind(combined_data, mean_data)
}

filtered_data <- combined_data %>%
  mutate(
    Dose          = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),
    Chemical      = factor(Chemical, levels = chemical_order)
  )


filtered_data$significance <- NA_character_
for (i in 1:nrow(filtered_data)) {
  match_significance <- significance_df %>%
    filter(
      time == filtered_data$time[i],
      chemical == as.character(filtered_data$Chemical[i]),
      dataset_name == filtered_data$Dataset[i],
        group2 == filtered_data$Sample[i]
    ) %>%
    slice_head(n = 1) %>%
    pull(significance)

  filtered_data$significance[i] <- ifelse(length(match_significance) == 1, match_significance, NA_character_)
}


vehicle_lines <- filtered_data %>%
  filter(Dose == 0) %>%
  group_by(time, Marker, Chemical) %>%
  summarise(vehicle_mean = mean(mean_stat, na.rm = TRUE), .groups = "drop")
filtered_data <- filtered_data %>%
  mutate(y_position_label = mean_stat + se_stat + 0.2)
replicate_data <- do.call(rbind, filtered_datasets2) %>%
  rename(mean_stat = value) %>%  
  mutate(
    Dose = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),          
    Chemical = factor(Chemical, levels = chemical_order)
  )

plot_file <- paste0(output_dir, "CFSE_Jurkat_byTime.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data, 
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "Percentage Divided (%)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  geom_text(
    data = filtered_data[!is.na(filtered_data$significance), ],
    aes(x = log_Treatment, y = y_position_label, label = significance, color = time),
    size = 5, check_overlap = TRUE
  )


print(plot)
dev.off()

print(plot)
plot_file <- paste0(output_dir, "CFSE_Jurkat_byTimenosig.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data,  
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "Percentage Divided (%)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
dev.off()

print(plot)
```
#Live %

```{r}
chemical_order <- c("PFOS", "PFOA")
selected_objects <- c("live")
filtered_datasets2 <- filtered_datasets[names(filtered_datasets) %in% selected_objects]

significance_results <- list()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]]

  dataset <- dataset %>% mutate(Dose = as.numeric(Dose))

  unique_times <- sort(unique(dataset$time), na.last = NA)

  for (tt in unique_times) {
    time_data <- dataset %>% filter(time == tt)

    unique_chemicals <- unique(time_data$Chemical)

    for (chem in unique_chemicals) {
      chem_data <- time_data %>% filter(Chemical == chem)

      anova_model <- aov(value ~ Sample + Error(Replicate/Sample), data = chem_data)

      tukey_results <- emmeans(anova_model, pairwise ~ Sample)
      pairwise_results <- as.data.frame(tukey_results$contrasts)

      pairwise_results <- pairwise_results %>%
        mutate(
          significance = case_when(
            p.value < 0.001 ~ "***",
            p.value < 0.01  ~ "**",
            p.value < 0.05  ~ "*",
            p.value >= 0.05 & p.value < 0.099 ~ ".",
            TRUE ~ NA_character_
          )
        ) %>%
        separate(contrast, into = c("group1", "group2"), sep = " - ") %>%
        mutate(
          group1 = str_replace_all(group1, "[()]", ""),
          group2 = str_replace_all(group2, "[()]", "")
        )

      max_y   <- max(chem_data$value, na.rm = TRUE)
      increment <- max_y * 0.05

      significance_labels <- pairwise_results %>%
        filter(group1 %in% "PHA0uM" | group2 %in% "PHA0uM") %>%
        mutate(y.position = max_y + (row_number() - 1) * increment)

      if (!is.list(significance_results[[dataset_name]])) {
        significance_results[[dataset_name]] <- list()
      }
      if (!is.list(significance_results[[dataset_name]][[as.character(tt)]])) {
        significance_results[[dataset_name]][[as.character(tt)]] <- list()
      }
      significance_results[[dataset_name]][[as.character(tt)]][[chem]] <- significance_labels
    }
  }
}
significance_df <- data.frame()

for (dataset_name in names(significance_results)) {
  for (tt in names(significance_results[[dataset_name]])) {
    for (chem in names(significance_results[[dataset_name]][[tt]])) {
      sig_lab <- significance_results[[dataset_name]][[tt]][[chem]]
      if (is.null(sig_lab) || nrow(sig_lab) == 0) next
      sig_lab$chemical     <- chem
      sig_lab$dataset_name <- dataset_name
      sig_lab$time         <- as.numeric(tt)
      significance_df <- rbind(significance_df, sig_lab)
    }
  }
}
extract_um <- function(x) {
  as.numeric(str_match(x, "PHA\\s*(-?\\d*\\.?\\d+)\\s*uM")[,2])
}

significance_df <- significance_df %>%
  mutate(
    swap_needed = group1 != "PHA0uM" & group2 == "PHA0uM",
    tmp_g1 = if_else(swap_needed, group2, group1),
    tmp_g2 = if_else(swap_needed, group1, group2),
    group1 = tmp_g1,
    group2 = tmp_g2
  ) %>%
  select(-tmp_g1, -tmp_g2, -swap_needed) %>%
  mutate(
    dose_num = extract_um(group2) 
  )

significance_df <- significance_df %>% arrange(time, chemical, dataset_name)

combined_data <- data.frame()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]] %>%
    mutate(Dose = as.numeric(Dose))

  mean_data <- dataset %>%
    group_by(time, Chemical, Dose, Sample) %>%
    summarise(
      mean_stat = mean(value, na.rm = TRUE),
      se_stat   = std.error(value) * 2.365,
      .groups   = "drop"
    ) %>%
    mutate(
      Dataset = dataset_name,
      Marker  = case_when(grepl("CFSE", dataset_name) ~ "CFSE")
    )

  combined_data <- rbind(combined_data, mean_data)
}

filtered_data <- combined_data %>%
  mutate(
    Dose          = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),
    Chemical      = factor(Chemical, levels = chemical_order)
  )

filtered_data$significance <- NA_character_
for (i in 1:nrow(filtered_data)) {
  match_significance <- significance_df %>%
    filter(
      time == filtered_data$time[i],
      chemical == as.character(filtered_data$Chemical[i]),
      dataset_name == filtered_data$Dataset[i],
        group2 == filtered_data$Sample[i]
    ) %>%
    slice_head(n = 1) %>%
    pull(significance)

  filtered_data$significance[i] <- ifelse(length(match_significance) == 1, match_significance, NA_character_)
}

vehicle_lines <- filtered_data %>%
  filter(Dose == 0) %>%
  group_by(time, Marker, Chemical) %>%
  summarise(vehicle_mean = mean(mean_stat, na.rm = TRUE), .groups = "drop")
filtered_data <- filtered_data %>%
  mutate(y_position_label = mean_stat + se_stat + 5)
replicate_data <- do.call(rbind, filtered_datasets2) %>%
  rename(mean_stat = value) %>%   
  mutate(
    Dose = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),           
    Chemical = factor(Chemical, levels = chemical_order)
  )

plot_file <- paste0(output_dir, "CFSE_Jurkat_live.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data,   # <-- your long-format replicate-level data
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "Percentage Divided (%)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  geom_text(
    data = filtered_data[!is.na(filtered_data$significance), ],
    aes(x = log_Treatment, y = y_position_label, label = significance, color = time),
    size = 5, check_overlap = TRUE
  )


print(plot)
dev.off()

print(plot)
plot_file <- paste0(output_dir, "CFSE_Jurkat_livenosig.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data,   
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "Percentage Divided (%)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
dev.off()

print(plot)
```

#dead
```{r}
chemical_order <- c("PFOS", "PFOA")
selected_objects <- c("dead_fi")
filtered_datasets2 <- filtered_datasets[names(filtered_datasets) %in% selected_objects]

significance_results <- list()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]]

  dataset <- dataset %>% mutate(Dose = as.numeric(Dose))

  unique_times <- sort(unique(dataset$time), na.last = NA)

  for (tt in unique_times) {
    time_data <- dataset %>% filter(time == tt)

    unique_chemicals <- unique(time_data$Chemical)

    for (chem in unique_chemicals) {
      chem_data <- time_data %>% filter(Chemical == chem)
      anova_model <- aov(value ~ Sample + Error(Replicate/Sample), data = chem_data)

      tukey_results <- emmeans(anova_model, pairwise ~ Sample)
      pairwise_results <- as.data.frame(tukey_results$contrasts)

      pairwise_results <- pairwise_results %>%
        mutate(
          significance = case_when(
            p.value < 0.001 ~ "***",
            p.value < 0.01  ~ "**",
            p.value < 0.05  ~ "*",
            p.value >= 0.05 & p.value < 0.099 ~ ".",
            TRUE ~ NA_character_
          )
        ) %>%
        separate(contrast, into = c("group1", "group2"), sep = " - ") %>%
        mutate(
          group1 = str_replace_all(group1, "[()]", ""),
          group2 = str_replace_all(group2, "[()]", "")
        )

      max_y   <- max(chem_data$value, na.rm = TRUE)
      increment <- max_y * 0.05

      significance_labels <- pairwise_results %>%
        filter(group1 %in% "PHA0uM" | group2 %in% "PHA0uM") %>%
        mutate(y.position = max_y + (row_number() - 1) * increment)

      if (!is.list(significance_results[[dataset_name]])) {
        significance_results[[dataset_name]] <- list()
      }
      if (!is.list(significance_results[[dataset_name]][[as.character(tt)]])) {
        significance_results[[dataset_name]][[as.character(tt)]] <- list()
      }
      significance_results[[dataset_name]][[as.character(tt)]][[chem]] <- significance_labels
    }
  }
}

significance_df <- data.frame()

for (dataset_name in names(significance_results)) {
  for (tt in names(significance_results[[dataset_name]])) {
    for (chem in names(significance_results[[dataset_name]][[tt]])) {
      sig_lab <- significance_results[[dataset_name]][[tt]][[chem]]
      if (is.null(sig_lab) || nrow(sig_lab) == 0) next
      sig_lab$chemical     <- chem
      sig_lab$dataset_name <- dataset_name
      sig_lab$time         <- as.numeric(tt)
      significance_df <- rbind(significance_df, sig_lab)
    }
  }
}
extract_um <- function(x) {
  as.numeric(str_match(x, "PHA\\s*(-?\\d*\\.?\\d+)\\s*uM")[,2])
}

significance_df <- significance_df %>%
  mutate(
    swap_needed = group1 != "PHA0uM" & group2 == "PHA0uM",
    tmp_g1 = if_else(swap_needed, group2, group1),
    tmp_g2 = if_else(swap_needed, group1, group2),
    group1 = tmp_g1,
    group2 = tmp_g2
  ) %>%
  select(-tmp_g1, -tmp_g2, -swap_needed) %>%
  mutate(
    dose_num = extract_um(group2) 
  )

significance_df <- significance_df %>% arrange(time, chemical, dataset_name)


combined_data <- data.frame()

for (dataset_name in names(filtered_datasets2)) {
  dataset <- filtered_datasets2[[dataset_name]] %>%
    mutate(Dose = as.numeric(Dose))

  mean_data <- dataset %>%
    group_by(time, Chemical, Dose, Sample) %>%
    summarise(
      mean_stat = mean(value, na.rm = TRUE),
      se_stat   = std.error(value) * 2.365,
      .groups   = "drop"
    ) %>%
    mutate(
      Dataset = dataset_name,
      Marker  = case_when(grepl("CFSE", dataset_name) ~ "CFSE")
    )

  combined_data <- rbind(combined_data, mean_data)
}

filtered_data <- combined_data %>%
  mutate(
    Dose          = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),
    Chemical      = factor(Chemical, levels = chemical_order)
  )

filtered_data$significance <- NA_character_
for (i in 1:nrow(filtered_data)) {
  match_significance <- significance_df %>%
    filter(
      time == filtered_data$time[i],
      chemical == as.character(filtered_data$Chemical[i]),
      dataset_name == filtered_data$Dataset[i],
        group2 == filtered_data$Sample[i]
    ) %>%
    slice_head(n = 1) %>%
    pull(significance)

  filtered_data$significance[i] <- ifelse(length(match_significance) == 1, match_significance, NA_character_)
}

vehicle_lines <- filtered_data %>%
  filter(Dose == 0) %>%
  group_by(time, Marker, Chemical) %>%
  summarise(vehicle_mean = mean(mean_stat, na.rm = TRUE), .groups = "drop")
filtered_data <- filtered_data %>%
  mutate(y_position_label = mean_stat + se_stat + 0.5)
replicate_data <- do.call(rbind, filtered_datasets2) %>%
  rename(mean_stat = value) %>%  
  mutate(
    Dose = as.numeric(Dose),
    log_Treatment = log10(Dose + 1),        
    Chemical = factor(Chemical, levels = chemical_order)
  )

plot_file <- paste0(output_dir, "CFSE_Jurkat_dead.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data,  
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "rMFI (dead cells)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  geom_text(
    data = filtered_data[!is.na(filtered_data$significance), ],
    aes(x = log_Treatment, y = y_position_label, label = significance, color = time),
    size = 5, check_overlap = TRUE
  )


print(plot)
dev.off()

print(plot)

plot_file <- paste0(output_dir, "CFSE_Jurkat_deadnosig.png")
png(plot_file, width = 1875, height = 1000, res = 300)

filtered_data   <- filtered_data   %>% mutate(time = factor(time))
replicate_data  <- replicate_data  %>% mutate(time = factor(time))
vehicle_lines  <- vehicle_lines  %>% mutate(time = factor(time))
time_colors <- c("48" = "#b12a90", "72" = "#d35171", "96" = "#f68f44")
plot <- ggplot(filtered_data, aes(x = log_Treatment, y = mean_stat, color = time)) +
  geom_point(
    data = replicate_data,   
    aes(x = log_Treatment, y = mean_stat, color = time),
    position = position_jitter(width = 0.05),
    alpha = 0.5,
    size = 1.8,
    inherit.aes = FALSE
  ) +
  geom_point(size = 2) +
  geom_hline(
    data = vehicle_lines,
    aes(yintercept = vehicle_mean, color = time),
    linetype = "dashed",
    inherit.aes = FALSE
  ) +
  geom_errorbar(aes(ymin = mean_stat - se_stat, ymax = mean_stat + se_stat), width = 0.1) +
  facet_grid(Chemical ~ time, scales = "fixed") +
  scale_color_manual(values = time_colors) +
  scale_fill_manual(values = time_colors) +
  labs(x = "Log10 Concentration (µM)", y = "rMFI (dead cells)", color = "Chemical") +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.major = element_line(size = 0.5),
    panel.grid.minor = element_blank()
  )


print(plot)
dev.off()

print(plot)
```
